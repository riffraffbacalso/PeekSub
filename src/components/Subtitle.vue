<script lang="ts">
  import { defineComponent, ComponentPublicInstance as CPI } from "vue";
  import { mapState } from "pinia";
  import { useSubtitleStore } from "../store";

  export default defineComponent({
    data() {
      return {
        pEl: null as CPI<HTMLParagraphElement> | null,
        isFocused: false as boolean,
      };
    },
    computed: {
      ...mapState(useSubtitleStore, ["srtBlocks", "selectedBlock"]),
    },
    methods: {
      onFocus() {
        this.isFocused = true;
      },
      onBlur() {
        this.isFocused = false;
      },
      onKeyDown(e: KeyboardEvent) {
        // if (e.shiftKey && e.key === "Enter") {
        // e.preventDefault();
        // const selection = window.getSelection();
        // const range = selection!.getRangeAt(0);
        // const newline = document.createTextNode("\n");
        // range.insertNode(newline);
        // range.setStartAfter(newline);
        // range.setEndAfter(newline);
        // selection!.removeAllRanges();
        // selection!.addRange(range);
        // }
        if (!e.shiftKey && e.key === "Enter") {
          e.preventDefault();
          this.srtBlocks[this.selectedBlock!].subtitles =
            this.pEl!.innerText.split("\n");
          this.pEl!.blur();
        }
      },
      },
    mounted() {
      this.pEl = this.$refs.pEl as CPI<HTMLParagraphElement>;
    },
  });
</script>

<template>
  <p
    ref="pEl"
    class="subtitles"
    contenteditable="true"
    @focus="onFocus"
    @blur="onBlur"
    @keydown="onKeyDown"
  >
    <span class="subtitle-line" v-if="isFocused">
      {{ srtBlocks[selectedBlock!]?.subtitles.join("\n") }}
    </span>
    <span
      class="subtitle-line"
      v-else
      v-html="srtBlocks[selectedBlock!]?.subtitles.join('\n')"
    />
  </p>
</template>

<style>
  .subtitles {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: max-content;
    margin-bottom: 1rem;
    color: white;
    font-size: calc(1.275rem + 0.3vw);
    text-align: center;
    text-shadow: 1px 1px 1px black;
    transform: translateX(-50%);
  }

  .subtitles[contenteditable]:focus {
    background-color: rgba(80, 80, 80, 0.25);
    outline: none;
  }

  .subtitle-line {
    display: block;
    min-height: 1lh;
    white-space: pre-wrap;
  }
</style>
